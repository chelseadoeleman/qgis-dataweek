!function(t){if("function"==typeof define&&define.amd)define(["leaflet"],t);else if("undefined"!=typeof module)module.exports=t(require("leaflet"));else{if(void 0===this.L)throw"Leaflet must be loaded first!";this.L.WMS=this.L.wms=t(this.L)}}(function(h){var r={};"keys"in Object||(Object.keys=function(t){var e=[];for(var i in t)t.hasOwnProperty(i)&&e.push(i);return e}),r.Source=h.Layer.extend({options:{untiled:!0,identify:!0},initialize:function(t,e){h.setOptions(this,e),this.options.tiled&&(this.options.untiled=!1),this._url=t,this._subLayers={},this._overlay=this.createOverlay(this.options.untiled)},createOverlay:function(t){var e={};for(var i in this.options)"untiled"!=i&&"identify"!=i&&(e[i]=this.options[i]);return t?r.overlay(this._url,e):r.tileLayer(this._url,e)},onAdd:function(){this.refreshOverlay()},getEvents:function(){return this.options.identify?{click:this.identify}:{}},setOpacity:function(t){this.options.opacity=t,this._overlay&&this._overlay.setOpacity(t)},bringToBack:function(){this.options.isBack=!0,this._overlay&&this._overlay.bringToBack()},bringToFront:function(){this.options.isBack=!1,this._overlay&&this._overlay.bringToFront()},getLayer:function(t){return r.layer(this,t)},addSubLayer:function(t){this._subLayers[t]=!0,this.refreshOverlay()},removeSubLayer:function(t){delete this._subLayers[t],this.refreshOverlay()},refreshOverlay:function(){var t=Object.keys(this._subLayers).join(",");this._map&&(t?(this._overlay.setParams({layers:t}),this._overlay.addTo(this._map)):this._overlay.remove())},identify:function(t){var e=this.getIdentifyLayers();e.length&&this.getFeatureInfo(t.containerPoint,t.latlng,e,this.showFeatureInfo)},getFeatureInfo:function(t,i,e,r){var s=this.getFeatureInfoParams(t,e),n=this._url+h.Util.getParamString(s,this._url);this.showWaiting(),this.ajax(n,function(t){this.hideWaiting();var e=this.parseFeatureInfo(t,n);r.call(this,i,e)})},ajax:function(t,e){(function(t,e){var i=this,r=new XMLHttpRequest;r.onreadystatechange=function(){4===r.readyState&&(200===r.status?e.call(i,r.responseText):e.call(i,"error"))},r.open("GET",t),r.send()}).call(this,t,e)},getIdentifyLayers:function(){return this.options.identifyLayers?this.options.identifyLayers:Object.keys(this._subLayers)},getFeatureInfoParams:function(t,e){var i,r;this.options.untiled?i=this._overlay.wmsParams:((r=this.createOverlay(!0)).updateWmsParams(this._map),(i=r.wmsParams).layers=e.join(","));var s={request:"GetFeatureInfo",query_layers:e.join(","),X:Math.round(t.x),Y:Math.round(t.y)};return h.extend({},i,s)},parseFeatureInfo:function(t,e){return"error"==t&&(t="<iframe src='"+e+"' style='border:none'>"),t},showFeatureInfo:function(t,e){this._map&&this._map.openPopup(e,t)},showWaiting:function(){this._map&&(this._map._container.style.cursor="progress")},hideWaiting:function(){this._map&&(this._map._container.style.cursor="default")}}),r.source=function(t,e){return new r.Source(t,e)},r.Layer=h.Layer.extend({initialize:function(t,e,i){h.setOptions(this,i),t.addSubLayer||(t=r.getSourceForUrl(t,i)),this._source=t,this._name=e},onAdd:function(){this._source._map||this._source.addTo(this._map),this._source.addSubLayer(this._name)},onRemove:function(){this._source.removeSubLayer(this._name)},setOpacity:function(t){this._source.setOpacity(t)},bringToBack:function(){this._source.bringToBack()},bringToFront:function(){this._source.bringToFront()}}),r.layer=function(t,e,i){return new r.Layer(t,e,i)};var i={};return r.getSourceForUrl=function(t,e){return i[t]||(i[t]=r.source(t,e)),i[t]},r.TileLayer=h.TileLayer.WMS,r.tileLayer=h.tileLayer.wms,r.Overlay=h.Layer.extend({defaultWmsParams:{service:"WMS",request:"GetMap",version:"1.1.1",layers:"",styles:"",format:"image/jpeg",transparent:!1},options:{crs:null,uppercase:!1,attribution:"",opacity:1,isBack:!1,minZoom:0,maxZoom:18},initialize:function(t,e){this._url=t;var i={},r={};for(var s in e)s in this.options?r[s]=e[s]:i[s]=e[s];h.setOptions(this,r),this.wmsParams=h.extend({},this.defaultWmsParams,i)},setParams:function(t){h.extend(this.wmsParams,t),this.update()},getAttribution:function(){return this.options.attribution},onAdd:function(){this.update()},onRemove:function(t){this._currentOverlay&&(t.removeLayer(this._currentOverlay),delete this._currentOverlay),this._currentUrl&&delete this._currentUrl},getEvents:function(){return{moveend:this.update}},update:function(){if(this._map){this.updateWmsParams();var t=this.getImageUrl();if(this._currentUrl!=t){this._currentUrl=t;var e=this._map.getBounds(),i=h.imageOverlay(t,e,{opacity:0});i.addTo(this._map),i.once("load",function(){if(!this._map)return;{if(i._url!=this._currentUrl)return void this._map.removeLayer(i);this._currentOverlay&&this._map.removeLayer(this._currentOverlay)}(this._currentOverlay=i).setOpacity(this.options.opacity?this.options.opacity:1),!0===this.options.isBack&&i.bringToBack();!1===this.options.isBack&&i.bringToFront()},this),(this._map.getZoom()<this.options.minZoom||this._map.getZoom()>this.options.maxZoom)&&this._map.removeLayer(i)}}},setOpacity:function(t){this.options.opacity=t,this._currentOverlay&&this._currentOverlay.setOpacity(t)},bringToBack:function(){this.options.isBack=!0,this._currentOverlay&&this._currentOverlay.bringToBack()},bringToFront:function(){this.options.isBack=!1,this._currentOverlay&&this._currentOverlay.bringToFront()},updateWmsParams:function(t){t||(t=this._map);var e=t.getBounds(),i=t.getSize(),r=parseFloat(this.wmsParams.version),s=this.options.crs||t.options.crs,n=1.3<=r?"crs":"srs",o=s.project(e.getNorthWest()),a=s.project(e.getSouthEast()),u={width:i.x,height:i.y};u[n]=s.code,u.bbox=(1.3<=r&&s===h.CRS.EPSG4326?[a.y,o.x,o.y,a.x]:[o.x,a.y,a.x,o.y]).join(","),h.extend(this.wmsParams,u)},getImageUrl:function(){var t=this.options.uppercase||!1,e=h.Util.getParamString(this.wmsParams,this._url,t);return this._url+e}}),r.overlay=function(t,e){return new r.Overlay(t,e)},r});